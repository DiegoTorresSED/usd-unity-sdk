#build_args:
#  no_python: --build-monolithic --alembic --no-python --no-imaging
#  full: --build-monolithic --alembic --openimageio
#usd_versions:
#  - version: 19.11
#  - version: 20.02
build_platforms:
#  - name: win
#    type: Unity::VM
#    image: package-ci/win10:stable
#    flavor: b1.large
  - name: mac
    type: Unity::VM::osx
    image: filmtv/usd_build_macos_image:latest
    flavor: m1.mac
  - name: linux
    type: Unity::VM
    image: filmtv/usd_build_linux_image:latest
    flavor: b1.large
---
{% for platform in build_platforms %}
{{platform.name}}_v20.02_no_python:
  name: {{platform.name}} - Build USD v20.02 on (no python)
  skip_checkout: true
  agent:
    type: {{platform.type}}
    image: {{platform.image}}
    flavor: {{platform.flavor}}
  commands:
    - |
      wget https://github.com/PixarAnimationStudios/USD/archive/v20.02.zip
      unzip v20.02.zip
      cd USD-20.02
      python build_scripts/build_usd.py --build-monolithic --alembic --no-python --no-imaging ../libs/usd-v20.02_no_python
  artifacts:
      {{platform.name}}_v20.02_no_python:
        paths:
          - "libs/usd-v20.02_no_python/**"
{% endfor %}

{% for platform in build_platforms %}
{{platform.name}}_v20.02:
  name: {{platform.name}} - Build USD v20.02 (full)
  skip_checkout: true
  agent:
    type: {{platform.type}}
    image: {{platform.image}}
    flavor: {{platform.flavor}}
  commands:
    - |
      wget https://github.com/PixarAnimationStudios/USD/archive/v20.02.zip
      unzip v20.02.zip
      cd USD-20.02
      python build_scripts/build_usd.py --build-monolithic --alembic --openimageio ../libs/usd-v20.02
  artifacts:
    {{platform.name}}_v20.02:
      paths:
        - "libs/usd-v20.02/**"
{% endfor %}

{% for platform in build_platforms %}
{{platform.name}}_usd_v20.02_bindings:
  name: {{platform.name}} - Build USD v20.02 C# bindings
  agent:
    type: {{platform.type}}
    image: {{platform.image}}
    flavor: {{platform.flavor}}
  dependencies:
    - .yamato/build_usd.yml#{{platform.name}}_v20.02
    - .yamato/build_usd.yml#{{platform.name}}_v20.02_no_python
  commands:
    - |
        mkdir build
        cd build
        cmake -DPXR_USD_LOCATION=/home/bokken/libs/usd-v20.02_no_python -DUSD_GENSCHEMA=${PXR_USD_LOCATION}/bin -DCMAKE_MODULE_PATH=../cmake/modules ../cmake/
        make install -j8
  artifacts:
      {{platform.name}}_usdCs_v20.02:
        paths:
          - "package/Runtime/Plugins/x86_64/Linux/**"
  {% endfor %}
